<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8; 
        }
        .card {
            background-color: white;
            border-radius: 1.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 40, 80, 0.05);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .timer-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e3a8a;
            background: #e0f2fe;
            border: 8px solid #3b82f6;
        }
        .pro-feature-locked {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none; 
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="system-message" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 hidden justify-center items-center">
        <div class="card p-6 w-11/12 max-w-sm text-center">
            <h3 id="message-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="message-body" class="text-gray-600 mb-6"></p>
            <div id="message-actions" class="flex justify-center space-x-3 space-x-reverse">
                <button onclick="closeSystemMessage()" class="btn-primary flex-1">Ø­Ø³Ù†Ø§Ù‹</button>
            </div>
        </div>
    </div>
    
    <header class="flex justify-between items-center mb-6 p-4 card">
        <div class="flex items-center space-x-2 space-x-reverse">
            <span class="text-2xl font-extrabold text-[#3b82f6]">StudyFlow</span>
        </div>
        <div class="flex items-center space-x-4 space-x-reverse">
            <p class="text-sm text-gray-700">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="user-display-name" class="font-bold cursor-pointer" onclick="showSecretTestButton()"></span></p>
            <button id="user-profile-btn" class="p-2 rounded-full hover:bg-gray-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </button>
        </div>
    </header>

    <div id="motivation-message" class="mb-6 p-4 text-center rounded-xl bg-yellow-100 text-yellow-800 font-semibold shadow-inner">
        </div>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <section class="lg:col-span-2 space-y-6">

            <div class="card p-6 flex flex-col items-center justify-center space-y-4">
                <h2 class="text-xl font-bold text-gray-800">Ù…Ø¤Ù‚Øª Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…</h2>
                <div id="timer-display" class="timer-circle">
                    50:00
                </div>
                <p id="timer-status" class="text-md font-medium text-blue-600">Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</p>
                <p class="text-sm text-gray-500">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙŠÙˆÙ…: <span id="remaining-daily-time" class="font-bold text-green-600">0 Ø³Ø§Ø¹Ø©</span></p>
                <p class="text-sm text-gray-500">Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="current-lesson-name" class="font-bold text-indigo-600">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯</span></p>
                <div class="flex space-x-4 space-x-reverse">
                    <button id="start-btn" class="btn-primary">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© (50 Ø¯Ù‚ÙŠÙ‚Ø©)</button>
                    <button id="reset-btn" class="p-2 bg-red-100 text-red-600 rounded-lg transition hover:bg-red-200" disabled>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</button>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø´Ø§Ù…Ù„ ÙˆØ§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="total-lessons" class="block text-sm font-medium text-gray-700">1. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</label>
                        <input type="number" id="total-lessons" placeholder="Ù…Ø«Ø§Ù„: 17 Ø¯Ø±Ø³" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="daily-target" class="block text-sm font-medium text-gray-700">2. Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³):</label>
                        <input type="number" id="daily-target" placeholder="Ù…Ø«Ø§Ù„: 3 Ø¯Ø±ÙˆØ³" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="daily-limit" class="block text-sm font-medium text-gray-700">3. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:</label>
                        <input type="number" id="daily-limit" placeholder="Ù…Ø«Ø§Ù„: 4 Ø³Ø§Ø¹Ø§Øª" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="target-grade" class="block text-sm font-medium text-gray-700">4. Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© / Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:</label>
                        <input type="text" id="target-grade" placeholder="Ù…Ø«Ø§Ù„: A+ Ø£Ùˆ 95%" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <h3 class="font-semibold text-lg text-gray-700 mt-4 mb-2">Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ÙØ®Ø·Ø· Ù„Ù‡Ø§ Ù„Ù„ÙŠÙˆÙ… (<span id="daily-lessons-count">0</span>):</h3>
                <div id="daily-lessons-list" class="space-y-2 mb-4">
                    <p class="text-gray-500">Ø­Ø¯Ø¯ Ø®Ø·ØªÙƒ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±ÙˆØ³...</p>
                    </div>
                
                <button onclick="saveStudyPlan()" class="btn-primary w-full">Ø­ÙØ¸ Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
                
                <div id="progress-analysis" class="mt-4 p-4 rounded-xl bg-indigo-50 border-l-4 border-indigo-400">
                    <h3 class="font-bold text-indigo-800 mb-2">ØªØ­Ù„ÙŠÙ„ StudyFlow Ù„Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©:</h3>
                    <p id="remaining-lessons-display" class="text-gray-700">Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span class="font-bold">...</span></p>
                    <p id="suggested-days" class="text-gray-700">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù„Ù„Ø¥Ù†Ù‡Ø§Ø¡: <span class="font-bold">...</span></p>
                    <p id="best-strategy" class="font-semibold text-indigo-600 mt-2">Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ÙŠÙˆÙ…: <span class="font-normal">...</span></p>
                </div>
            </div>

        </section>

        <section class="lg:col-span-1 space-y-6">

            <div class="card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©</h2>
                <div id="user-id-display" class="bg-blue-50 p-3 rounded-lg text-sm mb-4 text-center">
                    Ù…Ø¹Ø±Ù‘Ù Ø­Ø³Ø§Ø¨Ùƒ (ID): <span id="current-user-id" class="font-mono font-bold text-blue-800 select-all">...</span>
                </div>

                <div class="mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ID):</h3>
                    <div class="flex space-x-2 space-x-reverse">
                        <input type="text" id="friend-id-input" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ØµØ¯ÙŠÙ‚ Ù‡Ù†Ø§" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        <button onclick="addFriend()" class="p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>

                <h3 class="font-semibold text-gray-700 mb-2">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡:</h3>
                <div id="friends-list" class="space-y-3">
                    <p id="loading-friends" class="text-gray-500 text-center">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡...</p>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">StudyFlow Pro: Ø§Ù„ØªØ±Ù‚ÙŠØ© ÙˆØ§Ù„Ø¯Ø¹Ù…</h2>
                
                <div class="space-y-3 mb-6">
                    <h3 class="font-semibold text-gray-700">Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„ØªØ±ÙƒÙŠØ²:</h3>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <audio id="study-audio" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" loop></audio>
                        <button id="play-music-btn" class="p-2 rounded-full bg-indigo-500 text-white hover:bg-indigo-600 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </button>
                        <p class="text-sm">Ø£ØºÙ†ÙŠØ© ØªØ±ÙƒÙŠØ² ÙˆØ§Ø­Ø¯Ø© (Ù…Ø¬Ø§Ù†ÙŠØ©)</p>
                    </div>
                    
                    <div id="pro-music-feature" class="pro-feature-locked p-3 border-2 border-dashed border-gray-300 rounded-lg">
                        <p class="font-bold text-sm text-gray-500">Ù‚ÙˆØ§Ø¦Ù… ØªØ´ØºÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯Ø© ÙˆÙ…ØµØ§Ø¯Ø± Ø®Ø§Ø±Ø¬ÙŠØ© (Ù…ÙŠØ²Ø© Pro)</p>
                        <button onclick="handleProFeature('music')" class="text-blue-500 text-xs mt-1 underline">Ø¬Ø±Ø¨ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ´ØºÙŠÙ„</button>
                    </div>
                </div>

                <div id="secret-pro-test" class="mt-2 text-center hidden">
                    <button onclick="activateProTest()" class="text-xs text-red-500 underline">âœ… ØªÙØ¹ÙŠÙ„ Pro Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± (Admin)</button>
                </div>
                
                <p id="pro-status" class="text-center font-bold text-red-500 mb-3">Ø­Ø³Ø§Ø¨Ùƒ Ù‡Ùˆ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</p>
                <button onclick="showProUpgrade()" id="upgrade-button" class="btn-primary w-full mt-4 bg-yellow-500 hover:bg-yellow-600">ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ StudyFlow Pro</button>
            </div>

        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙˆÙ‰ Ø³Ø¬Ù„ Firebase
        setLogLevel('debug');

        // Ù…ØªØºÙŠØ±Ø§Øª Firebase Ø§Ù„Ø¹Ø§Ù…Ø© (ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ğŸ”‘ğŸ”‘ğŸ”‘ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø¯ÙØ¹ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ($50)
        const PAYPAL_ONETIME_LINK = "https://www.paypal.com/ncp/payment/26UKMUF357WEW"; 

        let app, db, auth;
        let currentUserId = null;
        let dbInitialized = false;
        
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.studyState = {
            timerInterval: null,
            isStudying: false,
            timeRemaining: 50 * 60, 
            isBreak: false,
            pomodoroDuration: 50 * 60, 
            breakDuration: 10 * 60,   
            totalLessons: 0,
            dailyTarget: 0,
            dailyLimitHours: 0,
            targetGrade: '',
            lessonsInputToday: [], 
            lessonsCompletedToday: 0,
            studyTimeTodayMinutes: 0,
            currentLessonIndex: 0, 
            currentUserData: null,
            isProUser: false 
        };
        
        // Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ­ÙÙŠØ²ÙŠØ©
        const motivationQuotes = [
            "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ù‡Ùˆ Ø§Ù„Ø¬Ø³Ø± Ø¨ÙŠÙ† Ø§Ù„Ù‡Ø¯Ù ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø².",
            "Ù…Ø§ ØªÙØ¹Ù„Ù‡ Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ Ù…Ø§ Ø³ÙŠØ­Ø³Ù† ÙƒÙ„ Ø£ÙŠØ§Ù…Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.",
            "Ø§Ù„Ù†Ø¬Ø§Ø­ Ù„ÙŠØ³ Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©ØŒ Ø¨Ù„ Ø§Ù„Ø³Ø¹Ø§Ø¯Ø© Ù‡ÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø¬Ø§Ø­.",
            "ØªØ°ÙƒØ±: ÙƒÙ„ 50 Ø¯Ù‚ÙŠÙ‚Ø© ØªØ±ÙƒÙŠØ² Ù‡ÙŠ Ø®Ø·ÙˆØ© Ø¹Ù…Ù„Ø§Ù‚Ø© Ù†Ø­Ùˆ Ù‡Ø¯ÙÙƒ.",
            "Ø£ÙØ¶Ù„ Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù‡ÙŠ Ø®Ù„Ù‚Ù‡."
        ];
        
        // Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¯Ø±Ø³
        const studyTips = [
            "ğŸ§  Ù†ØµÙŠØ­Ø© Ù„Ù„ØªØ±ÙƒÙŠØ²: Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¹Ø§Ø¯ Ø¹Ù† Ù‡Ø§ØªÙÙƒ Ø£Ùˆ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙ‡ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©. Ù…ÙƒØ§Ù† Ù‡Ø§Ø¯Ø¦ ÙŠØ¹Ù†ÙŠ ØªØ±ÙƒÙŠØ²Ø§Ù‹ Ø£Ø¹Ù…Ù‚.",
            "ğŸ§© ØªØ¬Ø²Ø¦Ø© Ø§Ù„Ù…Ø§Ø¯Ø©: Ù‡Ù„ ÙƒØ§Ù† Ø§Ù„Ø¯Ø±Ø³ ØµØ¹Ø¨Ø§Ù‹ØŸ Ù‚Ù… Ø¨ØªÙ‚Ø³ÙŠÙ…Ù‡ Ø¥Ù„Ù‰ Ø£Ù‚Ø³Ø§Ù… Ø£ØµØºØ± (Ù…Ø«Ù„ 'Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ø¯Ø±Ø³') ÙÙŠ Ø¬Ù„Ø³ØªÙƒ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©. Ø§Ù„ØªØ¬Ø²Ø¦Ø© ØªØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨.",
            "â“ Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ù‚Ø¨Ù„ Ø£Ù† ØªØ¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©ØŒ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ ØµØ¹Ø¨Ø§Ù‹ Ù„Ù… ØªØ³ØªØ·Ø¹ Ø­Ù„Ù‡ ÙÙŠ Ø§Ù„Ù€ 50 Ø¯Ù‚ÙŠÙ‚Ø©. Ù‡Ø°Ø§ ÙŠÙˆØ¬Ù‡ ØªØ±ÙƒÙŠØ²Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹.",
            "ğŸ“ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©: Ø§Ø¨Ø¯Ø£ Ø¬Ù„Ø³ØªÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ù…Ø§ Ø¯Ø±Ø³ØªÙ‡ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©. Ù‡Ø°Ø§ ÙŠØ¹Ø²Ø² Ø°Ø§ÙƒØ±ØªÙƒ ÙˆÙŠØ¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©.",
            "ğŸ’§ Ø§Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ø¬ÙŠØ¯Ø©: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ø´Ø±Ø¨Øª ÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø§Ø¡ ÙˆØ£Ù† ÙˆØ¶Ø¹ÙŠØ© Ø¬Ù„ÙˆØ³Ùƒ Ù…Ø±ÙŠØ­Ø© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©."
        ];

        const getRandomStudyTip = () => {
            const randomIndex = Math.floor(Math.random() * studyTips.length);
            return studyTips[randomIndex];
        };


        // ----------------------------------------------------------------------
        // # ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø³ÙŠØ·Ø© (UI Utilities)
        // ----------------------------------------------------------------------

        window.showSystemMessage = (title, body, actionsHtml = '<button onclick="closeSystemMessage()" class="btn-primary flex-1">Ø­Ø³Ù†Ø§Ù‹</button>') => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').textContent = body;
            document.getElementById('message-actions').innerHTML = actionsHtml;
            document.getElementById('system-message').classList.remove('hidden');
            document.getElementById('system-message').classList.add('flex');
        };

        window.closeSystemMessage = () => {
            document.getElementById('system-message').classList.remove('flex');
            document.getElementById('system-message').classList.add('hidden');
        };

        // ğŸ”‘ ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Pro - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ø¯ÙØ¹ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù…Ø¯Ø© 3 Ø£Ø´Ù‡Ø±
        window.showProUpgrade = () => {
            
            if (!currentUserId) {
                showSystemMessage("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø­Ø³Ø§Ø¨.");
                return;
            }

            // ØªØ¬Ù‡ÙŠØ² Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Custom Parameter)
            const onetimeLinkWithID = `${PAYPAL_ONETIME_LINK}&custom=${currentUserId}`;
            
            const actionsHtml = `
                <a href="${onetimeLinkWithID}" target="_blank" class="btn-primary w-full bg-indigo-500 hover:bg-indigo-600 text-center">Ø´Ø±Ø§Ø¡ ØªØ±Ù‚ÙŠØ© 3 Ø£Ø´Ù‡Ø± ($50)</a>
            `;
            showSystemMessage(
                "ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ StudyFlow Pro - Ù…Ø¯Ø© 3 Ø£Ø´Ù‡Ø±", 
                "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙŠØ²Ø§Øª Pro (Ù‚ÙˆØ§Ø¦Ù… ØªØ´ØºÙŠÙ„ Ù…ØªÙ‚Ø¯Ù…Ø©ØŒ ØªØªØ¨Ø¹ Ø£Ø¯Ø§Ø¡) Ù„Ù…Ø¯Ø© 90 ÙŠÙˆÙ…Ø§Ù‹ Ù„Ø¯Ø¹Ù… ØªØ·ÙˆÙŠØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.",
                actionsHtml
            );
        };
        
        // ğŸ”‘ ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙŠØ²Ø© Pro Ù…Ù‚ÙÙ„Ø©
        window.handleProFeature = (featureName) => {
            if (window.studyState.isProUser) {
                if (featureName === 'music') {
                    showSystemMessage("Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", "Ù…ÙŠØ²Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø®ØµØµØ© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†! (ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ù…Ø¬ Ù…Ø´ØºÙ„ Spotify/YouTube Ù‡Ù†Ø§).");
                }
            } else {
                showProUpgrade();
            }
        };

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­ÙÙŠØ²ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        const displayRandomMotivation = () => {
            const randomIndex = Math.floor(Math.random() * motivationQuotes.length);
            document.getElementById('motivation-message').textContent = "âœ¨ " + motivationQuotes[randomIndex] + " âœ¨";
        };
        
        // Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        const updateDailyTimeDisplay = () => {
            const limitMinutes = window.studyState.dailyLimitHours * 60;
            const remainingMinutes = limitMinutes - window.studyState.studyTimeTodayMinutes;
            const remainingHours = Math.floor(remainingMinutes / 60);
            const remainingMins = remainingMinutes % 60;
            
            const displayElement = document.getElementById('remaining-daily-time');
            if (remainingMinutes <= 0 && limitMinutes > 0) {
                displayElement.textContent = 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ!';
                displayElement.classList.remove('text-green-600');
                displayElement.classList.add('text-red-600');
            } else if (limitMinutes === 0) {
                displayElement.textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯)';
                displayElement.classList.remove('text-red-600');
                displayElement.classList.add('text-green-600');
            } else {
                displayElement.textContent = `${remainingHours} Ø³ Ùˆ ${remainingMins} Ø¯`;
                displayElement.classList.remove('text-red-600');
                displayElement.classList.add('text-green-600');
            }
        };

        // ğŸ”‘ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Pro Ø£Ùˆ Ù„Ø§
        const updateProUI = () => {
            const isPro = window.studyState.isProUser;
            const statusElement = document.getElementById('pro-status');
            const upgradeButton = document.getElementById('upgrade-button');
            const proMusicFeature = document.getElementById('pro-music-feature');
            
            // Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆØ¹Ø±Ø¶Ù‡
            let expiryDate = null;
            if (window.studyState.currentUserData && window.studyState.currentUserData.proExpiry) {
                expiryDate = new Date(window.studyState.currentUserData.proExpiry);
            }

            if (isPro) {
                const formattedExpiry = expiryDate ? expiryDate.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Ø¯Ø§Ø¦Ù…';
                statusElement.innerHTML = `âœ… Ø­Ø³Ø§Ø¨Ùƒ Ù‡Ùˆ StudyFlow Pro! <br><span class="text-sm font-normal">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${formattedExpiry}</span>`;
                statusElement.classList.remove('text-red-500');
                statusElement.classList.add('text-green-500');
                
                upgradeButton.textContent = "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø¯Ø¹Ù…Ùƒ!";
                upgradeButton.disabled = true;
                upgradeButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                upgradeButton.classList.add('bg-gray-500', 'hover:bg-gray-600');

                proMusicFeature.classList.remove('pro-feature-locked');
                proMusicFeature.classList.add('pro-feature');

            } else {
                statusElement.textContent = "Ø­Ø³Ø§Ø¨Ùƒ Ù‡Ùˆ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©";
                statusElement.classList.remove('text-green-500');
                statusElement.classList.add('text-red-500');

                upgradeButton.textContent = "ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ StudyFlow Pro";
                upgradeButton.disabled = false;
                upgradeButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                upgradeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');

                proMusicFeature.classList.add('pro-feature-locked');
                proMusicFeature.classList.remove('pro-feature');
            }
        };


        // ----------------------------------------------------------------------
        // # Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        // ----------------------------------------------------------------------

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            dbInitialized = true;
        } else {
            console.error("Firebase config is missing. Friend features will be disabled.");
        }


        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('current-user-id').textContent = currentUserId;
                document.getElementById('user-display-name').textContent = "Ø§Ù„Ø·Ø§Ù„Ø¨ " + currentUserId.substring(0, 4);
                
                await loadUserData();
                
                if (dbInitialized) {
                    setupFriendListener();
                }

            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    showSystemMessage("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©", "Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©.");
                }
            }
        });

        // ----------------------------------------------------------------------
        // # ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ (Firestore)
        // ----------------------------------------------------------------------
        
        const getUserDocRef = (uid) => {
            return doc(db, 'artifacts', appId, 'users', uid, 'studyData', 'profile');
        };

        const getPublicStatsRef = (uid) => {
            return doc(db, 'artifacts', appId, 'public', 'data', 'userStats', uid);
        };

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore
        const loadUserData = async () => {
            if (!dbInitialized || !currentUserId) return;
            
            try {
                const docRef = getUserDocRef(currentUserId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    window.studyState.currentUserData = docSnap.data();
                    const data = window.studyState.currentUserData;

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    document.getElementById('total-lessons').value = data.totalLessons || '';
                    document.getElementById('daily-target').value = data.dailyTarget || '';
                    document.getElementById('daily-limit').value = data.dailyLimitHours || '';
                    document.getElementById('target-grade').value = data.targetGrade || '';
                    
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                    window.studyState.totalLessons = data.totalLessons || 0;
                    window.studyState.dailyTarget = data.dailyTarget || 0;
                    window.studyState.dailyLimitHours = data.dailyLimitHours || 0;
                    window.studyState.targetGrade = data.targetGrade || '';
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ø´ØªØ±Ø§Ùƒ Pro
                    const isPro = data.isPro || false;
                    const proExpiry = data.proExpiry ? new Date(data.proExpiry) : null;
                    const isExpired = proExpiry && proExpiry < new Date();
                    
                    window.studyState.isProUser = isPro && !isExpired;
                    
                    if (isExpired && isPro) {
                         // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
                         await updateDoc(docRef, { isPro: false });
                    }

                    // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…
                    const today = new Date().toDateString();
                    const todayData = data.dailyTracking?.[today] || {};
                    window.studyState.lessonsCompletedToday = todayData.lessonsCompleted || 0;
                    window.studyState.studyTimeTodayMinutes = todayData.studyTimeMinutes || 0;
                    window.studyState.lessonsInputToday = data.lessonsInputToday || [];

                } else {
                    const initialData = { totalLessons: 0, dailyTarget: 0, dailyLimitHours: 0, targetGrade: '', lessonsInputToday: [], friends: [], totalSessions: 0, dailyTracking: {}, isPro: false, proExpiry: null };
                    await setDoc(docRef, initialData);
                    window.studyState.currentUserData = initialData;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
                updateLessonInputs();
                updateOptimalStrategy();
                updateDailyTimeDisplay();
                updateProUI(); // ğŸ”‘ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Pro

            } catch (e) {
                console.error("Error loading user data: ", e);
            }
        };

        // ØªØ­Ø¯ÙŠØ« ÙˆØ¹Ø±Ø¶ Ø­Ù‚ÙˆÙ„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        const updateLessonInputs = () => {
            const container = document.getElementById('daily-lessons-list');
            const countDisplay = document.getElementById('daily-lessons-count');
            const target = window.studyState.dailyTarget;
            container.innerHTML = '';
            countDisplay.textContent = target;

            if (target === 0) {
                container.innerHTML = '<p class="text-red-500">Ø­Ø¯Ø¯ Ù‡Ø¯ÙÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³.</p>';
                window.studyState.lessonsInputToday = [];
                return;
            }

            for (let i = 0; i < target; i++) {
                const lessonName = window.studyState.lessonsInputToday[i] || '';
                container.innerHTML += `
                    <input type="text" id="lesson-day-${i}" value="${lessonName}" 
                           placeholder="Ø§Ù„Ø¯Ø±Ø³ Ø±Ù‚Ù… ${i + 1} Ù„Ù„ÙŠÙˆÙ…" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                `;
            }

            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const currentLesson = window.studyState.lessonsInputToday[window.studyState.currentLessonIndex] || 'Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø£ÙˆÙ„';
            document.getElementById('current-lesson-name').textContent = currentLesson;

        };
        
        // Ø­ÙØ¸ Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©
        window.saveStudyPlan = async () => {
            const totalLessons = parseInt(document.getElementById('total-lessons').value) || 0;
            const dailyTarget = parseInt(document.getElementById('daily-target').value) || 0;
            const dailyLimitHours = parseInt(document.getElementById('daily-limit').value) || 0;
            const targetGrade = document.getElementById('target-grade').value.trim();

            if (dailyTarget > totalLessons && totalLessons > 0) {
                 showSystemMessage("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø£ÙƒØ¨Ø± Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©.");
                 return;
            }

            // Ø¬Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const newLessonsInput = [];
            const target = Math.min(dailyTarget, totalLessons);
            for (let i = 0; i < target; i++) {
                const lessonElement = document.getElementById(`lesson-day-${i}`);
                if (lessonElement) {
                    newLessonsInput.push(lessonElement.value.trim() || `Ø§Ù„Ø¯Ø±Ø³ Ø±Ù‚Ù… ${i + 1}`);
                }
            }
            window.studyState.lessonsInputToday = newLessonsInput;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            window.studyState.totalLessons = totalLessons;
            window.studyState.dailyTarget = dailyTarget;
            window.studyState.dailyLimitHours = dailyLimitHours;
            window.studyState.targetGrade = targetGrade;

            if (dbInitialized && currentUserId) {
                try {
                    const docRef = getUserDocRef(currentUserId);
                    await updateDoc(docRef, {
                        totalLessons,
                        dailyTarget,
                        dailyLimitHours,
                        targetGrade,
                        lessonsInputToday: window.studyState.lessonsInputToday
                    });
                    showSystemMessage("ØªÙ… Ø§Ù„Ø­ÙØ¸", "ØªÙ… Ø­ÙØ¸ Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù„ÙŠÙ„.");
                } catch (e) {
                    console.error("Error saving study plan: ", e);
                    showSystemMessage("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸", "Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.");
                }
            } else {
                showSystemMessage("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹", "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­. Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªÙ„Ù‚Ø§Ø¦ÙŠ) Ù„ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ…Ø±.");
            }
            
            updateLessonInputs();
            updateOptimalStrategy();
            updateDailyTimeDisplay();
        };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©
        const updateOptimalStrategy = () => {
            const { totalLessons, dailyTarget, targetGrade } = window.studyState;
            const remainingLessons = totalLessons - window.studyState.lessonsCompletedToday;
            const daysToFinish = dailyTarget > 0 ? Math.ceil(remainingLessons / dailyTarget) : 0;
            
            document.getElementById('remaining-lessons-display').innerHTML = `Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span class="font-bold">${remainingLessons}</span>`;
            document.getElementById('suggested-days').innerHTML = `Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù„Ù„Ø¥Ù†Ù‡Ø§Ø¡: <span class="font-bold">${daysToFinish > 0 ? daysToFinish + ' Ø£ÙŠØ§Ù…' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>`;
            
            let strategyMessage = "Ø§Ø¨Ø¯Ø£ Ø¨ÙˆØ¶Ø¹ Ø®Ø·Ø© Ø¯Ø±Ø§Ø³ÙŠØ© ÙˆØ§Ø¶Ø­Ø©.";
            if (dailyTarget > 0 && remainingLessons > 0) {
                strategyMessage = `Ø£Ù†Øª Ø¨Ø­Ø§Ø¬Ø© Ù„Ø¯Ø±Ø§Ø³Ø© ${dailyTarget} Ø¯Ø±Ø³ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø¯ÙÙƒ! Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ.`;
            } else if (remainingLessons === 0 && totalLessons > 0) {
                strategyMessage = `ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©. Ø§Ø³ØªØ¹Ø¯ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØªÙ‚Ø¯ÙŠØ± ${targetGrade}.`;
            }

            document.getElementById('best-strategy').innerHTML = `Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ÙŠÙˆÙ…: <span class="font-normal">${strategyMessage}</span>`;
        };

        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ ÙÙŠ Firestore
        const updateStudySessionStats = async (minutesAdded) => {
            if (!dbInitialized || !currentUserId) return;
            
            const today = new Date().toDateString();
            window.studyState.studyTimeTodayMinutes += minutesAdded;

            try {
                const userDocRef = getUserDocRef(currentUserId);
                const publicStatsRef = getPublicStatsRef(currentUserId);
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§ØµØ© (ÙˆÙ‚Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ù„Ù„ÙŠÙˆÙ…)
                await updateDoc(userDocRef, {
                    [`dailyTracking.${today}.studyTimeMinutes`]: window.studyState.studyTimeTodayMinutes,
                    [`dailyTracking.${today}.lessonsCompleted`]: window.studyState.lessonsCompletedToday,
                    totalSessions: (window.studyState.currentUserData.totalSessions || 0) + 1
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
                await setDoc(publicStatsRef, {
                    userId: currentUserId,
                    userName: document.getElementById('user-display-name').textContent,
                    lastUpdate: new Date().toISOString(),
                    totalSessions: (window.studyState.currentUserData.totalSessions || 0) + 1,
                    studyTimeMinutesToday: window.studyState.studyTimeTodayMinutes
                }, { merge: true });

            } catch (e) {
                console.error("Error updating session: ", e);
            }
        };


        // ----------------------------------------------------------------------
        // # ÙˆØ¸Ø§Ø¦Ù Ù…Ø¤Ù‚Øª Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ (Timer)
        // ----------------------------------------------------------------------

        const updateTimerDisplay = () => {
            const minutes = Math.floor(window.studyState.timeRemaining / 60);
            const seconds = window.studyState.timeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
        };

        const startTimer = () => {
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
            const limitMinutes = window.studyState.dailyLimitHours * 60;
            if (!window.studyState.isBreak && limitMinutes > 0 && window.studyState.studyTimeTodayMinutes >= limitMinutes) {
                showSystemMessage("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ", "Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©. Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø±Ø§Ø­Ø©!", 
                    `<button onclick="closeSystemMessage()" class="btn-primary flex-1">Ø³Ø£ØªÙˆÙ‚Ù Ø§Ù„ÙŠÙˆÙ…</button>`);
                resetTimer(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
                return;
            }

            if (window.studyState.timerInterval) return;
            
            window.studyState.isStudying = true;
            document.getElementById('start-btn').textContent = "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
            document.getElementById('reset-btn').disabled = false;
            document.getElementById('timer-status').textContent = window.studyState.isBreak ? "ÙˆÙ‚Øª Ø§Ø³ØªØ±Ø§Ø­Ø© (10 Ø¯Ù‚Ø§Ø¦Ù‚)" : "Ø¬Ù„Ø³Ø© Ø¯Ø±Ø§Ø³Ø© (50 Ø¯Ù‚ÙŠÙ‚Ø©)";
            document.getElementById('timer-status').classList.toggle('text-blue-600', !window.studyState.isBreak);
            document.getElementById('timer-status').classList.toggle('text-green-600', window.studyState.isBreak);

            window.studyState.timerInterval = setInterval(() => {
                window.studyState.timeRemaining--;
                updateTimerDisplay();

                if (window.studyState.timeRemaining <= 0) {
                    clearInterval(window.studyState.timerInterval);
                    window.studyState.timerInterval = null;
                    
                    // ØªØ´ØºÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ
                    new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3').play();

                    if (!window.studyState.isBreak) {
                        // Ù†Ù‡Ø§ÙŠØ© Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© (50 Ø¯Ù‚ÙŠÙ‚Ø©)
                        
                        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙˆÙ‚Øª (50 Ø¯Ù‚ÙŠÙ‚Ø©)
                        updateStudySessionStats(50);
                        updateDailyTimeDisplay();

                        promptForLessonCompletion(); // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ø±Ø­Ù„Ø© Ø³Ø¤Ø§Ù„ "Ù‡Ù„ Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ø¯Ø±Ø³ØŸ"
                        
                    } else {
                        // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© (10 Ø¯Ù‚Ø§Ø¦Ù‚)
                        showSystemMessage("Ø¹Ø¯Ù†Ø§ Ù„Ù„Ø¯Ø±Ø§Ø³Ø©!", "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø£Ùˆ Ø§Ù„ØªÙˆÙ‚Ù Ù„Ù„ÙŠÙˆÙ….");
                        window.studyState.isBreak = false;
                        window.studyState.timeRemaining = window.studyState.pomodoroDuration;
                        document.getElementById('start-btn').textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© (50 Ø¯Ù‚ÙŠÙ‚Ø©)";
                        displayRandomMotivation(); // Ø±Ø³Ø§Ù„Ø© ØªØ­ÙÙŠØ²ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
                        // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                    }
                }
            }, 1000);
        };
        
        const resetTimer = () => {
            clearInterval(window.studyState.timerInterval);
            window.studyState.timerInterval = null;
            window.studyState.isStudying = false;
            window.studyState.isBreak = false;
            window.studyState.timeRemaining = window.studyState.pomodoroDuration;
            document.getElementById('start-btn').textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© (50 Ø¯Ù‚ÙŠÙ‚Ø©)";
            document.getElementById('reset-btn').disabled = true;
            document.getElementById('timer-status').textContent = "Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©";
            document.getElementById('timer-status').classList.remove('text-green-600');
            document.getElementById('timer-status').classList.add('text-blue-600');
            updateTimerDisplay();
        };

        // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ Ø¬Ù„Ø³Ø© Ø§Ù„Ù€ 50 Ø¯Ù‚ÙŠÙ‚Ø©
        const promptForLessonCompletion = () => {
            const currentLesson = window.studyState.lessonsInputToday[window.studyState.currentLessonIndex] || 'Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ';
            
            // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø·Ù„Ø¨ Ø§Ù„ØªØ£ÙƒÙŠØ¯
            const actionsHtml = `
                <button onclick="handleLessonCompletion(true)" class="btn-primary bg-green-500 hover:bg-green-600 flex-1">Ù†Ø¹Ù…ØŒ Ø£Ù†Ù‡ÙŠØªÙ‡</button>
                <button onclick="handleLessonCompletion(false)" class="btn-primary bg-red-500 hover:bg-red-600 flex-1">Ù„Ø§ØŒ Ù„Ù… Ø£Ù†Ù‡ÙŠÙ‡</button>
            `;
            
            showSystemMessage(
                "Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ù…ÙƒØªÙ…Ù„ØŸ", 
                `Ù‡Ù„ Ø£ÙƒÙ…Ù„Øª Ø¯Ø±Ø³ "${currentLesson}" Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ`,
                actionsHtml
            );
        };
        
        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´Ø£Ù† Ø§Ù„Ø¯Ø±Ø³
        window.handleLessonCompletion = (isComplete) => {
            closeSystemMessage();
            
            if (isComplete) {
                // ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø³
                window.studyState.lessonsCompletedToday++;
                window.studyState.currentLessonIndex++; // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ
                updateOptimalStrategy(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…
                
                const nextLesson = window.studyState.lessonsInputToday[window.studyState.currentLessonIndex] || 'Ø§Ù†ØªÙ‡Øª Ø¯Ø±ÙˆØ³ Ø§Ù„ÙŠÙˆÙ…!';
                document.getElementById('current-lesson-name').textContent = nextLesson;

                showSystemMessage("Ù…Ù…ØªØ§Ø²!", `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥ÙƒÙ…Ø§Ù„ Ø¯Ø±Ø³! Ø­Ø§Ù† Ø§Ù„Ø¢Ù† ÙˆÙ‚Øª Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ù€ 10 Ø¯Ù‚Ø§Ø¦Ù‚.`);
                
            } else {
                // Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø³ - ÙŠØ¨Ù‚Ù‰ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¯Ø±Ø³
                const tip = getRandomStudyTip(); // Ø¬Ù„Ø¨ Ù†ØµÙŠØ­Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                showSystemMessage("Ù†ØµÙŠØ­Ø© StudyFlow Ù„Ùƒ!", tip); // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµÙŠØ­Ø©
            }
            
            // Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù‚Ø±Ø§Ø±
            window.studyState.isBreak = true;
            window.studyState.timeRemaining = window.studyState.breakDuration;
            document.getElementById('start-btn').textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©";
            startTimer(); // Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©

        };


        // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
        document.getElementById('start-btn').addEventListener('click', () => {
            if (window.studyState.timerInterval) {
                // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª
                clearInterval(window.studyState.timerInterval);
                window.studyState.timerInterval = null;
                document.getElementById('start-btn').textContent = "Ù…ØªØ§Ø¨Ø¹Ø©";
                document.getElementById('timer-status').textContent += " (Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª)";
            } else {
                // Ø¨Ø¯Ø¡ Ø£Ùˆ Ù…ØªØ§Ø¨Ø¹Ø©
                startTimer();
            }
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
             showSystemMessage("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙŠÙˆÙ…", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØŸ (Ø³ÙŠØ¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø¬Ù„Ø³Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙˆÙˆÙ‚Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø© ÙÙ‚Ø·).",
                `<button onclick="resetDailyProgress()" class="btn-primary bg-red-500 hover:bg-red-600 flex-1">Ù†Ø¹Ù…ØŒ Ø£Ø¹Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
                 <button onclick="closeSystemMessage()" class="btn-primary bg-gray-400 hover:bg-gray-500 flex-1">Ø¥Ù„ØºØ§Ø¡</button>`
            );
        });
        
        // ÙˆØ¸ÙŠÙØ© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ
        window.resetDailyProgress = async () => {
            closeSystemMessage();
            resetTimer(); 
            window.studyState.lessonsCompletedToday = 0;
            window.studyState.studyTimeTodayMinutes = 0;
            window.studyState.currentLessonIndex = 0;
            updateOptimalStrategy();
            updateDailyTimeDisplay();
            document.getElementById('current-lesson-name').textContent = window.studyState.lessonsInputToday[0] || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯';

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙŠ Firebase
            if (dbInitialized && currentUserId) {
                try {
                    const today = new Date().toDateString();
                    await updateDoc(getUserDocRef(currentUserId), {
                        [`dailyTracking.${today}.studyTimeMinutes`]: 0,
                        [`dailyTracking.${today}.lessonsCompleted`]: 0
                    });
                    showSystemMessage("ØªÙ…Øª Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©", "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªÙ‚Ø¯Ù… Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­.");
                } catch (e) {
                    console.error("Error resetting daily progress:", e);
                }
            }
        }


        // ----------------------------------------------------------------------
        // # ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠ (Ù„Ùƒ ÙƒÙ…Ø³Ø¤ÙˆÙ„)
        // ----------------------------------------------------------------------

        window.showSecretTestButton = () => {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠ ÙÙŠ Ù„ÙˆØ­Ø© Pro
            const secretButton = document.getElementById('secret-pro-test');
            secretButton.classList.remove('hidden');
            setTimeout(() => {
                secretButton.classList.add('hidden');
            }, 5000); // ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
        };

        window.activateProTest = async () => {
            if (!dbInitialized || !currentUserId) {
                showSystemMessage("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªÙ„Ù‚Ø§Ø¦ÙŠ) Ù„ØªÙØ¹ÙŠÙ„ Pro.");
                return;
            }
            
            // Ù„ØªØ¬Ø±Ø¨Ø© ÙØªØ±Ø© 3 Ø£Ø´Ù‡Ø±: Ù†Ø¶ÙŠÙ 3 Ø£Ø´Ù‡Ø± Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            const today = new Date();
            const expiryDate = new Date(today);
            expiryDate.setMonth(today.getMonth() + 3);

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Pro Ø¥Ù„Ù‰ true ÙˆØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            try {
                await updateDoc(getUserDocRef(currentUserId), {
                    isPro: true,
                    proExpiry: expiryDate.toISOString() // Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒÙ€ ISO String
                });
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                await loadUserData(); 
                
                closeSystemMessage();
                showSystemMessage("ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±!", "ØªÙ… ØªÙØ¹ÙŠÙ„ StudyFlow Pro Ù„Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù…Ø¯Ø© 3 Ø£Ø´Ù‡Ø±.");
            } catch (e) {
                console.error("Test Pro activation failed:", e);
                showSystemMessage("Ø®Ø·Ø£", "ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Pro. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Firebase.");
            }
        };


        // ----------------------------------------------------------------------
        // # ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (Friend Management)
        // ----------------------------------------------------------------------
        
        window.addFriend = async () => {
            const friendId = document.getElementById('friend-id-input').value.trim();
            if (!friendId || friendId === currentUserId) {
                showSystemMessage("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù ØµØ­ÙŠØ­ ÙˆÙ…Ø®ØªÙ„Ù Ø¹Ù† Ù…Ø¹Ø±Ù‘ÙÙƒ.");
                return;
            }
            if (!dbInitialized || !currentUserId) {
                showSystemMessage("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹) Ù„ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡.");
                return;
            }
            try {
                const docRef = getUserDocRef(currentUserId);
                const friendStats = await getDoc(getPublicStatsRef(friendId));
                if (!friendStats.exists()) {
                    showSystemMessage("Ø®Ø·Ø£", "Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØµØ¯ÙŠÙ‚Ùƒ Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
                    return;
                }
                await updateDoc(docRef, { friends: arrayUnion(friendId) });
                showSystemMessage("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©", `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯ÙŠÙ‚ ${friendId.substring(0, 4)} Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØ¸Ù‡Ø± ØªÙ‚Ø¯Ù…Ù‡ Ù‚Ø±ÙŠØ¨Ø§Ù‹.`);
                document.getElementById('friend-id-input').value = '';
            } catch (e) {
                console.error("Error adding friend: ", e);
                showSystemMessage("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯ÙŠÙ‚.");
            }
        };

        const setupFriendListener = () => {
            if (!dbInitialized || !currentUserId) return;
            const docRef = getUserDocRef(currentUserId);
            
            onSnapshot(docRef, async (docSnap) => {
                if (docSnap.exists() && docSnap.data().friends) {
                    const friendIds = docSnap.data().friends;
                    renderFriends(friendIds);
                } else {
                    document.getElementById('loading-friends').textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡. Ø£Ø¶Ù Ù…Ø¹Ø±Ù‘Ù ØµØ¯ÙŠÙ‚Ùƒ Ù„Ù„Ø¨Ø¯Ø¡.";
                }
            }, (error) => {
                console.error("Error setting up friend listener:", error);
                document.getElementById('loading-friends').textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© (Firebase).";
            });
        };

        const renderFriends = (friendIds) => {
            const friendsListDiv = document.getElementById('friends-list');
            friendsListDiv.innerHTML = '';
            
            if (friendIds.length === 0) {
                friendsListDiv.innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ù…Ø¶Ø§ÙÙˆÙ† Ø¨Ø¹Ø¯.</p>';
                return;
            }

            friendIds.forEach(friendId => {
                const publicRef = getPublicStatsRef(friendId);
                onSnapshot(publicRef, (statsSnap) => {
                    const friendData = statsSnap.exists() ? statsSnap.data() : { studyTimeMinutesToday: 0, totalSessions: 0 };
                    const friendCardId = `friend-card-${friendId}`;
                    let card = document.getElementById(friendCardId);
                    
                    if (!card) {
                        card = document.createElement('div');
                        card.id = friendCardId;
                        card.className = 'p-3 bg-gray-50 rounded-lg flex justify-between items-center';
                        friendsListDiv.appendChild(card);
                    }
                    
                    const totalMinutes = friendData.studyTimeMinutesToday || 0;
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    
                    card.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">Ø§Ù„ØµØ¯ÙŠÙ‚: ${friendId.substring(0, 4)}</p>
                            <p class="text-xs text-gray-500">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª: ${friendData.totalSessions || 0}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xl font-extrabold text-indigo-600">${hours}</span>
                            <p class="text-xs text-gray-500">Ø³Ø§Ø¹Ø© Ø¯Ø±Ø§Ø³Ø© Ø§Ù„ÙŠÙˆÙ…</p>
                        </div>
                    `;
                });
            });
        };
        
        // ----------------------------------------------------------------------
        // # ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
        // ----------------------------------------------------------------------
        
        const studyAudio = document.getElementById('study-audio');
        const playMusicBtn = document.getElementById('play-music-btn');
        let isPlaying = false;

        playMusicBtn.addEventListener('click', () => {
            if (isPlaying) {
                studyAudio.pause();
                playMusicBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
                isPlaying = false;
            } else {
                studyAudio.play().catch(e => {
                    console.error("Audio playback failed:", e);
                    showSystemMessage("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª", "Ø§Ù„Ù…ØªØµÙØ­ Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ ØªÙØ§Ø¹Ù„Ø§Ù‹ Ø£ÙˆÙ„ÙŠØ§Ù‹ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.");
                });
                playMusicBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
                isPlaying = true;
            }
        });


        // ----------------------------------------------------------------------
        // # Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        // ----------------------------------------------------------------------
        
        window.onload = () => {
            updateTimerDisplay();
            displayRandomMotivation();
            document.getElementById('current-user-id').textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...'; 
        };

    </script>
</body>
</html>
```eof

---

## 2. ğŸ“ Ù…Ù„Ù Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ: `index.js` (Firebase Cloud Function)

ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± `functions/index.js` ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Firebase Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹ ÙˆÙ…Ù†Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ±Ù‚ÙŠØ© **Pro Ù„Ù…Ø¯Ø© 3 Ø£Ø´Ù‡Ø±**.

```javascript:index.js
/**
 * Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠÙˆØ¶Ø¹ ÙÙŠ Ù…Ù„Ù functions/index.js ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Firebase
 * ÙˆÙ‡Ùˆ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙÙˆØ±ÙŠØ© (IPN/Webhook) Ù…Ù† PayPal
 * ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firestore.
 */

// 1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const axios = require('axios');
const querystring = require('querystring');

// ØªÙ‡ÙŠØ¦Ø© Firebase Admin SDK
admin.initializeApp();
const db = admin.firestore();

// 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© PayPal
// ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© 'https://www.paypal.com/cgi-bin/webscr'
const PAYPAL_URL = 'https://www.paypal.com/cgi-bin/webscr'; 

// 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙÙˆØ±ÙŠ (IPN) Ù…Ù† PayPal
// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¹Ù…Ù„ ÙƒÙ€ Webhook ÙˆØªØ³ØªÙ…Ø¹ Ù„Ø·Ù„Ø¨ POST
exports.paypalIPN = functions.https.onRequest(async (req, res) => {
    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ£ÙƒØ¯ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ù† Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ Ù‡Ùˆ POST
    if (req.method !== 'POST') {
        functions.logger.warn('Received non-POST request to IPN endpoint.', { method: req.method });
        return res.status(405).send('Method Not Allowed');
    }

    functions.logger.info('Received PayPal IPN notification.', { body: req.body });

    // 3.1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† PayPal
    let postData = { 'cmd': '_notify-validate' };
    postData = { ...postData, ...req.body };
    const verificationData = querystring.stringify(postData);

    try {
        // 3.2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ù„Ù‰ PayPal Ù„Ù„ØªØ­Ù‚Ù‚ (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±)
        const verificationResponse = await axios.post(PAYPAL_URL, verificationData, {
            headers: { 'content-type': 'application/x-www-form-urlencoded' }
        });

        // 3.3. ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ØªØ­Ù‚Ù‚
        if (verificationResponse.data === 'VERIFIED') {
            functions.logger.info('IPN Verified Successfully.', { body: req.body });

            const { 
                payment_status, 
                mc_gross,         // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
                receiver_email,   // Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…
                custom,           // Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„Ù†Ø§Ù‡ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
                txn_type          // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (web_accept Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
            } = req.body;

            // 4. ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ù…Ù„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø±ÙˆØ·
            
            // 4.1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
            if (payment_status !== 'Completed') {
                functions.logger.warn('Payment not completed.', { payment_status });
                return res.status(200).send('Payment status is not Completed.');
            }
            
            // 4.2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº (50 Ø¯ÙˆÙ„Ø§Ø±Ø§Ù‹)
            const expectedAmount = 50.00;
            if (parseFloat(mc_gross) !== expectedAmount) {
                functions.logger.warn('Amount mismatch.', { received: mc_gross, expected: expectedAmount });
                return res.status(200).send('Amount mismatch.');
            }
            
            // 4.3. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Custom ID)
            const userId = custom;
            if (!userId) {
                functions.logger.error('Missing Custom User ID in IPN!', { body: req.body });
                return res.status(200).send('Missing User ID.');
            }

            // 4.4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¯ÙØ¹ ØªÙ… Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø£Ù†Øª)
            const YOUR_PAYPAL_EMAIL = 'rxstoreaistore@gmail.com'; // âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            if (receiver_email !== YOUR_PAYPAL_EMAIL) {
                functions.logger.error('Receiver email mismatch!', { received: receiver_email });
                return res.status(200).send('Receiver email mismatch.');
            }
            
            // 5. ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ±Ù‚ÙŠØ© ÙÙŠ Firestore
            
            // 5.1. Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (3 Ø£Ø´Ù‡Ø± Ù…Ù† Ø§Ù„Ø¢Ù†)
            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + 3); // Ø¥Ø¶Ø§ÙØ© 3 Ø£Ø´Ù‡Ø±
            const expiryDateISO = expiryDate.toISOString();

            // 5.2. ØªØ­Ø¯ÙŠØ« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userDocRef = db.doc(`artifacts/${admin.app().options.projectId}/users/${userId}/studyData/profile`);
            await userDocRef.update({
                isPro: true,
                proExpiry: expiryDateISO,
                lastPaymentDate: admin.firestore.FieldValue.serverTimestamp(),
                paymentAmount: mc_gross,
                paymentTxnId: req.body.txn_id // Ù„Ø­ÙØ¸ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            });

            functions.logger.info(`User ${userId} upgraded to Pro. Expiry: ${expiryDateISO}`, { userId, expiryDateISO });
            return res.status(200).send('User updated successfully.');

        } else {
            functions.logger.warn('IPN Verification Failed.', { body: req.body });
            return res.status(200).send('IPN Verification Failed.');
        }

    } catch (error) {
        functions.logger.error('IPN processing error:', error);
        return res.status(500).send('Server Error');
    }
});
```eof

Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ù†Ø´Ø± Ø¯Ø§Ù„Ø© Firebase Cloud Function Ù‡Ø°Ù‡ Ø£Ùˆ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙÙˆØ±ÙŠØ© (IPN) ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ù„Ù‰ PayPalØŸ
